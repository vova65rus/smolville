<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
tg.enableClosingConfirmation();

const user = tg.initDataUnsafe?.user || { id: 0, first_name: 'Гость' };
const adminId = 366825437;
const isAdmin = user.id === adminId;
if (isAdmin) document.getElementById('adminBtn').classList.remove('hidden');

// ====== Настройка API ======
const AIRTABLE_EVENTS_API_KEY = 'YOUR_EVENTS_KEY';
const AIRTABLE_ADS_API_KEY = 'YOUR_ADS_KEY';
const AIRTABLE_BASE_ID = 'YOUR_BASE_ID';
const AIRTABLE_EVENTS_TABLE_NAME = 'tbl1wzVpDRpInIpMY';
const AIRTABLE_ADS_TABLE_NAME = 'tblILQr1xFKmkLTKB';
const IMGBB_API_KEY = 'YOUR_IMGBB_KEY';

const AIRTABLE_EVENTS_API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_EVENTS_TABLE_NAME)}`;
const AIRTABLE_ADS_API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_ADS_TABLE_NAME)}`;

const eventsContainer = document.getElementById('events');
const adBanner = document.getElementById('adBanner');
const adStatus = document.getElementById('adStatus');
const eventModal = document.getElementById('eventModal');
const closeModalBtn = document.getElementById('closeModal');
const adminPanel = document.getElementById('adminPanel');
const adminCloseBtn = document.getElementById('adminCloseBtn');
const adminForm = document.getElementById('adminForm');
const uploadImageBtn = document.getElementById('uploadImageBtn');
const previewImage = document.getElementById('previewImage');
const imageInput = document.getElementById('imageInput');
const adForm = document.getElementById('adForm');
const uploadAdImageBtn = document.getElementById('uploadAdImageBtn');
const adPreviewImage = document.getElementById('adPreviewImage');
const adImageInput = document.getElementById('adImageInput');
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');
const editImageBtn = document.getElementById('editImageBtn');
const editPreviewImage = document.getElementById('editPreviewImage');
const editImageInput = document.getElementById('editImageInput');
const cancelEdit = document.getElementById('cancelEdit');
const navButtons = document.querySelectorAll('.nav-btn');
const adminTabs = document.querySelectorAll('.admin-tab');
const manageList = document.getElementById('manageList');

// ====== Вспомогательные функции ======
function debounce(func, wait) {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

async function compressImage(file) {
  if (file.size < 4 * 1024 * 1024) return file;
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let width = img.width;
      let height = img.height;
      const maxSize = 600;
      if (width > maxSize || height > maxSize) {
        const ratio = Math.min(maxSize / width, maxSize / height);
        width *= ratio;
        height *= ratio;
      }
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(
        blob => {
          if (blob) resolve(new File([blob], file.name, { type: file.type, lastModified: Date.now() }));
          else reject(new Error('Не удалось сжать изображение'));
        },
        file.type,
        0.6
      );
    };
    img.onerror = () => reject(new Error('Ошибка загрузки изображения'));
    img.src = URL.createObjectURL(file);
  });
}

async function uploadToImgBB(file, button) {
  const originalText = button.textContent;
  button.textContent = 'Загрузка...';
  button.classList.add('loading');
  try {
    if (!file.type.startsWith('image/')) throw new Error('Файл должен быть изображением');
    if (file.size > 10 * 1024 * 1024) throw new Error('Файл превышает лимит в 10 МБ');
    let uploadFile = file.size > 4 * 1024 * 1024 ? await compressImage(file) : file;
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, true);
      const formData = new FormData();
      formData.append('image', uploadFile);
      xhr.timeout = 60000;
      xhr.onload = () => {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          if (data.success) resolve(data.data.url);
          else reject(new Error(data.error?.message || 'Ошибка загрузки'));
        } else reject(new Error(`Ошибка загрузки (HTTP ${xhr.status})`));
      };
      xhr.onerror = () => reject(new Error('Ошибка сети'));
      xhr.ontimeout = () => reject(new Error('Превышено время ожидания'));
      xhr.send(formData);
    });
  } catch (err) {
    tg.showAlert(`Ошибка загрузки изображения: ${err.message}`);
    return null;
  } finally {
    button.textContent = originalText;
    button.classList.remove('loading');
  }
}

async function getCachedData(key, fetchFn, ttl = 300000) {
  const cached = localStorage.getItem(key);
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < ttl) return data;
  }
  const data = await fetchFn();
  localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
  return data;
}

// ====== События ======
async function renderEvents() {
  eventsContainer.innerHTML = '<p class="text-center text-gray-400">Загрузка...</p>';
  try {
    const data = await getCachedData('events', async () => {
      const res = await fetch(AIRTABLE_EVENTS_API_URL, { headers: { Authorization: `Bearer ${AIRTABLE_EVENTS_API_KEY}` } });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    });
    const events = data.records.map(r => ({
      id: r.id,
      eventId: r.fields.ID,
      title: r.fields.Title,
      type: r.fields.Type,
      date: r.fields.Date,
      location: r.fields.Location,
      description: r.fields.Description,
      image: r.fields.Image?.[0]?.url || 'https://via.placeholder.com/120'
    }));
    eventsContainer.innerHTML = '';
    if (events.length === 0) return eventsContainer.innerHTML = '<p class="text-center text-gray-400">Нет мероприятий</p>';
    events.forEach((event, i) => {
      const card = document.createElement('div');
      card.className = 'event-card fade-in';
      card.style.animationDelay = `${i*0.1}s`;
      card.innerHTML = `
        <img src="${event.image}" alt="${event.title}" class="w-full h-3/4 object-cover rounded-t-lg" loading="lazy">
        <div class="p-1 text-center">
          <p class="text-xs font-semibold text-white">${event.date}</p>
          <p class="text-xs text-gray-400 line-clamp-1">${event.title}</p>
        </div>
      `;
      card.addEventListener('click', () => showEventDetails(event));
      eventsContainer.appendChild(card);
    });
  } catch(err) {
    eventsContainer.innerHTML = '<p class="text-center text-gray-400">Ошибка загрузки</p>';
    console.error(err);
  }
}

// ====== Реклама ======
async function renderAdBanner() {
  try {
    const data = await getCachedData('ads', async () => {
      const res = await fetch(AIRTABLE_ADS_API_URL, { headers: { Authorization: `Bearer ${AIRTABLE_ADS_API_KEY}` } });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    });
    const ad = data.records.find(r => r.fields.ID === 'ad1');
    if (ad && ad.fields.IMG?.[0] && ad.fields.URL) {
      adBanner.innerHTML = `<a href="${ad.fields.URL}" target="_blank"><img src="${ad.fields.IMG[0].url}" class="object-cover h-full w-full" loading="lazy"></a>`;
      adBanner.classList.remove('hidden');
      adStatus.classList.add('hidden');
    } else {
      adBanner.classList.add('hidden');
      adStatus.classList.remove('hidden');
      adStatus.textContent = 'Реклама не настроена';
    }
  } catch(err) {
    adBanner.classList.add('hidden');
    adStatus.classList.remove('hidden');
    adStatus.textContent = 'Ошибка загрузки рекламы';
    console.error(err);
  }
}

// ====== Запуск ======
renderEvents();
renderAdBanner();
</script>
