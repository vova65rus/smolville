<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smolville</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: url('bg.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      font-family: Arial, sans-serif;
    }
    .event-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      backdrop-filter: blur(5px);
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    .event-card:hover {
      transform: scale(1.02);
      background: rgba(255, 255, 255, 0.2);
    }
    .modal {
      background: rgba(0, 0, 0, 0.8);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #f0f0f0;
      color: #333;
      padding: 20px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 2000;
    }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    input, textarea, select { background: #fff; color: #333; border: 1px solid #ccc; }
    .tab { background: #e0e0e0; color: #333; padding: 8px 16px; border-radius: 4px 4px 0 0; cursor: pointer; }
    .tab.active { background: #fff; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .filter-btn { margin-right: 5px; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .filter-btn.active { background: #4ade80; color: #000; }
    .past-event { opacity: 0.5; }
    .gallery img { max-width: 100%; margin-top: 5px; border-radius: 5px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div class="container mx-auto p-4 flex-grow">
    <img src="logo.PNG" alt="Smolville Logo" class="mx-auto h-16 mb-4">
    <h1 class="text-2xl font-bold text-center mb-4">Smolville Events</h1>

    <!-- Фильтры и поиск -->
    <div class="mb-4 flex flex-wrap justify-center items-center gap-2">
      <button class="filter-btn active" data-type="">Все</button>
      <button class="filter-btn" data-type="Спорт">Спорт</button>
      <button class="filter-btn" data-type="Выставки">Выставки</button>
      <input type="text" id="searchInput" placeholder="Поиск по названию/месту" class="border p-2 rounded w-60">
      <select id="sortSelect" class="border p-2 rounded">
        <option value="asc">По дате ↑</option>
        <option value="desc">По дате ↓</option>
      </select>
    </div>

    <div id="events" class="grid grid-cols-1 gap-4"></div>
    <button id="adminBtn" class="hidden fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="showAdminModal()">Админ</button>
  </div>

  <!-- Модалки -->
  <div id="eventModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle" class="text-lg font-bold"></h2>
      <p id="modalDate"></p>
      <p id="modalLocation"></p>
      <p id="modalDescription"></p>
      <div class="gallery" id="modalGallery"></div>
      <button class="bg-blue-500 text-white px-4 py-2 mt-4 rounded-lg" onclick="closeEventModal()">Закрыть</button>
    </div>
  </div>

  <div id="adminModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-lg font-bold mb-4">Админ-панель</h2>
      <div class="flex mb-4">
        <div class="tab active" onclick="showTab('tab-list')">Список событий</div>
        <div class="tab" onclick="showTab('tab-form')">Добавить/Редактировать</div>
      </div>
      <div id="tab-list" class="tab-content active">
        <h3 class="text-md font-bold mb-2">Список событий</h3>
        <div id="eventList" class="mb-4"></div>
      </div>
      <div id="tab-form" class="tab-content">
        <h3 class="text-md font-bold mb-2">Добавить/Редактировать событие</h3>
        <form id="eventForm">
          <input type="hidden" id="eventRecordId">
          <input type="text" id="eventId" placeholder="ID (автоматически, если пусто)" class="border p-2 w-full mb-2">
          <input type="text" id="eventTitle" placeholder="Название" class="border p-2 w-full mb-2">
          <select id="eventType" class="border p-2 w-full mb-2">
            <option value="">Выберите тип</option>
            <option value="Спорт">Спорт</option>
            <option value="Выставки">Выставки</option>
          </select>
          <input type="date" id="eventDate" class="border p-2 w-full mb-2">
          <input type="text" id="eventLocation" placeholder="Место" class="border p-2 w-full mb-2">
          <textarea id="eventDescription" placeholder="Описание" class="border p-2 w-full mb-2"></textarea>
          <input type="file" id="eventImage" accept="image/*" multiple class="mb-2">
          <div id="previewImages" class="flex gap-2 flex-wrap mb-2"></div>
          <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg">Сохранить</button>
        </form>
      </div>
      <button class="bg-red-500 text-white px-4 py-2 mt-4 rounded-lg" onclick="closeAdminModal()">Закрыть</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const BACKEND_URL = 'https://smolville.onrender.com';
    const tg = window.Telegram?.WebApp;
    tg?.ready();
    tg?.expand();

    const user = tg?.initDataUnsafe?.user || { id: 0, first_name: 'Гость' };

    // Тост уведомления
    function showToast(message, duration=3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, duration);
    }

    // Форматирование дат
    const months = ['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'];
    function formatDate(dateStr) {
      if(!dateStr) return 'Без даты';
      const [year, month, day] = dateStr.split('-');
      const d = new Date(dateStr);
      const today = new Date();
      if(d.toDateString() === today.toDateString()) return 'Сегодня';
      const tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
      if(d.toDateString() === tomorrow.toDateString()) return 'Завтра';
      return `${parseInt(day,10)} ${months[parseInt(month,10)-1]} ${year}`;
    }

    let allEvents = [];

    async function renderEvents() {
      const eventsContainer = document.getElementById('events');
      eventsContainer.innerHTML = '<p class="text-center text-gray-400">Загрузка...</p>';
      try {
        const response = await fetch(`${BACKEND_URL}/api/events`, {mode:'cors'});
        const data = await response.json();
        allEvents = data.records || [];
        updateEventDisplay();
      } catch(err) {
        eventsContainer.innerHTML = `<p class="text-center text-gray-400">Ошибка: ${err.message}</p>`;
      }
    }

    function updateEventDisplay() {
      const container = document.getElementById('events');
      container.innerHTML = '';

      const filterType = document.querySelector('.filter-btn.active')?.dataset.type || '';
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sortOrder = document.getElementById('sortSelect').value;

      let events = [...allEvents];
      if(filterType) events = events.filter(e => e.fields.Type === filterType);
      if(searchTerm) events = events.filter(e => 
        (e.fields.Title?.toLowerCase().includes(searchTerm) || e.fields.Location?.toLowerCase().includes(searchTerm))
      );

      events.sort((a,b)=>{
        const d1 = new Date(a.fields.Date);
        const d2 = new Date(b.fields.Date);
        return sortOrder==='asc'?d1-d2:d2-d1;
      });

      if(events.length===0){
        container.innerHTML = '<p class="text-center text-gray-400">Мероприятия не найдены</p>';
        return;
      }

      events.forEach(record=>{
        const ev = record.fields;
        const d = new Date(ev.Date);
        const isPast = d < new Date();
        const div = document.createElement('div');
        div.className = 'event-card p-2 fade-in' + (isPast?' past-event':'');
        div.innerHTML = `
          <h3 class="text-sm font-bold">${ev.Title||'Без названия'}</h3>
          <p class="text-xs text-gray-400">${formatDate(ev.Date)}</p>
          <p class="text-xs text-gray-400">${ev.Location||'Без места'}</p>
          ${ev.Image?.map(img=>`<img src="${img.url}" class="w-full h-20 object-cover rounded-lg mt-1" loading="lazy">`).join('')||''}
        `;
        div.addEventListener('click',()=>showEventModal(record));
        container.appendChild(div);
      });
    }

    // Фильтры
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        updateEventDisplay();
      });
    });
    document.getElementById('searchInput').addEventListener('input', updateEventDisplay);
    document.getElementById('sortSelect').addEventListener('change', updateEventDisplay);

    // Модалки
    function showEventModal(record){
      const modal = document.getElementById('eventModal');
      const ev = record.fields;
      document.getElementById('modalTitle').textContent = ev.Title||'Без названия';
      document.getElementById('modalDate').textContent = formatDate(ev.Date);
      document.getElementById('modalLocation').textContent = ev.Location||'Без места';
      document.getElementById('modalDescription').textContent = ev.Description||'Без описания';
      const gallery = document.getElementById('modalGallery');
      gallery.innerHTML = ev.Image?.map(img=>`<img src="${img.url}">`).join('')||'';
      modal.classList.remove('hidden');
    }
    function closeEventModal(){document.getElementById('eventModal').classList.add('hidden');}

    // Админка
    document.getElementById('eventImage').addEventListener('change', function(){
      const preview = document.getElementById('previewImages');
      preview.innerHTML = '';
      Array.from(this.files).forEach(file=>{
        const reader = new FileReader();
        reader.onload = e=>{
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'w-20 h-20 object-cover rounded';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    document.getElementById('eventForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      // Валидация
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const location = document.getElementById('eventLocation').value.trim();
      if(!title || !date || !location){showToast('Заполните обязательные поля'); return;}
      showToast('Форма прошла валидацию. (Отправка на сервер)');

      // Здесь можно оставить существующую логику отправки на сервер
    });

    // Запуск
    renderEvents();
  </script>
</body>
</html>
