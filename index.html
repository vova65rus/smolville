<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Афиша Авто-Ивентов</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        .event { background: white; margin: 10px 0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .event h3 { margin: 0 0 10px; color: #333; }
        .event p { margin: 5px 0; }
        button { background: #0088cc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #006699; }
        #voting { display: none; }
        .nomination { display: block; margin: 10px 0; }
        .tab { display: none; }
        .tab.active { display: block; }
        nav { text-align: center; margin-bottom: 20px; }
        nav button { background: #ccc; margin: 0 5px; }
    </style>
</head>
<body>
    <nav>
        <button onclick="showTab('events')">Афиша</button>
        <button onclick="showTab('photos')">Фотоотчеты</button> <!-- Будущая вкладка -->
    </nav>

    <div id="events" class="tab active">
        <h2>Локальные авто-ивенты</h2>
        <div id="eventsList"></div>
        <button id="getLocation" onclick="requestLocation()">Поделиться локацией для голосования</button>
    </div>

    <div id="photos" class="tab">
        <h2>Фотоотчеты (в разработке)</h2>
        <p>Здесь будут фото с прошлых событий. Загрузка через Telegram-канал.</p>
    </div>

    <div id="voting" class="event">
        <h3 id="voteTitle"></h3>
        <div id="nominations"></div>
        <button onclick="submitVote()">Голосовать</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Полноэкранный режим

        let userLocation = null;
        let currentEventId = null;

        // Функция показа вкладок
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'photos') loadPhotos(); // В будущем
        }

        // Запрос локации
        function requestLocation() {
            tg.requestLocation().then(location => {
                userLocation = { lat: location.latitude, long: location.longitude };
                alert('Локация получена! Теперь можно голосовать.');
            }).catch(err => alert('Локация не получена: ' + err));
        }

        // Загрузка афиши
        async function loadEvents() {
            const response = await fetch('/api/events');
            const events = await response.json();
            const list = document.getElementById('eventsList');
            list.innerHTML = '';
            events.forEach(event => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <h3>${event.title}</h3>
                    <p>Дата: ${event.date}</p>
                    <p>Место: ${event.location}</p>
                    <p>${event.description}</p>
                    ${event.hasVoting ? `<button onclick="showVoting(${event.id}, '${event.title}', ${event.lat}, ${event.long})">Голосовать</button>` : ''}
                `;
                list.appendChild(div);
            });
        }

        // Показать голосование
        function showVoting(id, title, eventLat, eventLong) {
            currentEventId = id;
            document.getElementById('voteTitle').textContent = `Голосование: ${title}`;
            // Загрузить номинации с backend
            fetch(`/api/events/${id}/nominations`).then(res => res.json()).then(noms => {
                const nomsDiv = document.getElementById('nominations');
                nomsDiv.innerHTML = '';
                noms.forEach(nom => {
                    const btn = document.createElement('button');
                    btn.className = 'nomination';
                    btn.textContent = nom;
                    btn.onclick = () => selectNomination(nom);
                    nomsDiv.appendChild(btn);
                });
            });
            // Проверка гео (отправляем на backend)
            if (userLocation) {
                fetch('/api/check-location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userLat: userLocation.lat, userLong: userLocation.long, eventLat, eventLong })
                }).then(res => res.json()).then(data => {
                    if (!data.valid) alert('Вы не на мероприятии! Голосование недоступно.');
                    else document.getElementById('voting').style.display = 'block';
                });
            } else {
                alert('Поделитесь локацией для голосования.');
            }
        }

        // Выбор номинации (одна или несколько — доработайте логику)
        let selectedNoms = [];
        function selectNomination(nom) {
            // Логика: добавить/убрать из массива
            const idx = selectedNoms.indexOf(nom);
            if (idx > -1) selectedNoms.splice(idx, 1); else selectedNoms.push(nom);
        }

        // Отправка голоса
        async function submitVote() {
            if (selectedNoms.length === 0) return alert('Выберите номинацию!');
            const response = await fetch('/api/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ eventId: currentEventId, nominations: selectedNoms, initData: tg.initData })
            });
            if (response.ok) {
                alert('Голос учтен!');
                document.getElementById('voting').style.display = 'none';
            } else alert('Ошибка голосования.');
        }

        // Загрузка фото (заглушка)
        function loadPhotos() {
            // В будущем: fetch('/api/photos') и отображение галереи
            // Фото хранить как ссылки на Telegram файлы
        }

        // Инициализация
        loadEvents();
    </script>
</body>
</html>