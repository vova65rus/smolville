<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Smolville</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --hint-color: #707579;
      --link-color: #3390ec;
      --button-color: #3390ec;
      --button-text-color: #ffffff;
      --secondary-bg-color: #f4f4f5;
      --ad-bg-color: #fff3cd;
      --ad-text-color: #856404;
      --ad-border-color: #ffeaa7;
      --voting-bg-color: #fff0f0;
      --voting-text-color: #8b0000;
      --voting-border-color: #ffcccc;
      --voting-completed-bg: #f0fff0;
      --voting-completed-text: #006400;
      --voting-completed-border: #ccffcc;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #ffffff;
        --hint-color: #8e8e93;
        --secondary-bg-color: #2c2c2e;
        --ad-bg-color: #4a3c00;
        --ad-text-color: #ffd700;
        --ad-border-color: #665200;
        --voting-bg-color: #4a0000;
        --voting-text-color: #ff6b6b;
        --voting-border-color: #660000;
        --voting-completed-bg: #004d00;
        --voting-completed-text: #00ff00;
        --voting-completed-border: #006600;
      }
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .event-card {
      background: var(--secondary-bg-color);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      border: 1px solid var(--hint-color);
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .ad-card {
      background: var(--ad-bg-color);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 2px solid var(--ad-border-color);
      color: var(--ad-text-color);
    }

    .voting-card {
      background: var(--voting-bg-color);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 2px solid var(--voting-border-color);
      color: var(--voting-text-color);
      order: -1; /* Всегда первый */
    }

    .voting-card.completed {
      background: var(--voting-completed-bg);
      border-color: var(--voting-completed-border);
      color: var(--voting-completed-text);
    }

    .ad-badge, .voting-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
    }

    .ad-badge {
      background: var(--ad-border-color);
      color: var(--ad-text-color);
    }

    .voting-badge {
      background: var(--voting-border-color);
      color: var(--voting-text-color);
    }

    .modal {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--secondary-bg-color);
      color: var(--text-color);
      border-radius: 16px;
      border: 1px solid var(--hint-color);
    }

    .tab {
      background: var(--secondary-bg-color);
      color: var(--text-color);
      padding: 10px 16px;
      border-radius: 8px;
      margin: 0 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab:hover {
      background: var(--hint-color);
      color: var(--bg-color);
    }

    .tab.active {
      background: var(--button-color);
      color: var(--button-text-color);
    }

    input, textarea, select {
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--hint-color);
      border-radius: 8px;
      padding: 12px;
      width: 100%;
      margin-bottom: 12px;
    }

    input::placeholder, textarea::placeholder {
      color: var(--hint-color);
    }

    button {
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .vote-button {
      background: var(--button-color);
      color: var(--button-text-color);
    }

    .vote-button:hover {
      opacity: 0.9;
    }

    .vote-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .admin-panel {
      background: var(--secondary-bg-color);
      border-radius: 16px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .admin-section {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-color);
      border-radius: 12px;
      border: 1px solid var(--hint-color);
    }

    .results-bar {
      background: var(--hint-color);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }

    .results-fill {
      background: var(--button-color);
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div class="container mx-auto p-4 flex-grow">
    <a href="https://t.me/smolville_drift" target="_blank">
      <img src="logo.PNG" alt="Smolville Logo" class="mx-auto h-16 mb-4">
    </a>
    <h1 class="text-2xl font-bold text-center mb-4">Автособытия Сахалина</h1>
    <div id="events" class="grid grid-cols-1 gap-3"></div>
    <button id="adminBtn" class="hidden fixed bottom-6 right-6 bg-[var(--button-color)] text-[var(--button-text-color)] px-6 py-3 rounded-full shadow-lg transition-all hover:scale-105" onclick="showAdminModal()">Админ</button>
  </div>

  <!-- Модальные окна (остаются без изменений) -->
  <div id="eventModal" class="modal hidden">...</div>
  <div id="adModal" class="modal hidden">...</div>
  <div id="votingModal" class="modal hidden">...</div>

  <!-- Улучшенная админ-панель -->
  <div id="adminModal" class="modal hidden">
    <div class="modal-content admin-panel">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Админ-панель</h2>
        <button onclick="closeAdminModal()" class="text-2xl">&times;</button>
      </div>
      
      <div class="flex flex-wrap gap-2 mb-6">
        <div class="tab active" onclick="showTab('events')">События</div>
        <div class="tab" onclick="showTab('ads')">Реклама</div>
        <div class="tab" onclick="showTab('votings')">Голосования</div>
        <div class="tab" onclick="showTab('create-event')">+ Событие</div>
        <div class="tab" onclick="showTab('create-ad')">+ Реклама</div>
        <div class="tab" onclick="showTab('create-voting')">+ Голосование</div>
      </div>

      <!-- Список событий -->
      <div id="tab-events" class="tab-content active">
        <h3 class="text-lg font-semibold mb-4">Управление событиями</h3>
        <div id="eventsList" class="space-y-3"></div>
      </div>

      <!-- Список рекламы -->
      <div id="tab-ads" class="tab-content">
        <h3 class="text-lg font-semibold mb-4">Управление рекламой</h3>
        <div id="adsList" class="space-y-3"></div>
      </div>

      <!-- Список голосований -->
      <div id="tab-votings" class="tab-content">
        <h3 class="text-lg font-semibold mb-4">Управление голосованиями</h3>
        <div id="votingsList" class="space-y-3"></div>
      </div>

      <!-- Формы создания/редактирования -->
      <div id="tab-create-event" class="tab-content">...</div>
      <div id="tab-create-ad" class="tab-content">...</div>
      <div id="tab-create-voting" class="tab-content">...</div>
    </div>
  </div>

  <script>
    // ... остальной код JavaScript ...

    // Исправленная функция отображения событий
    async function renderEvents() {
      const eventsContainer = document.getElementById('events');
      eventsContainer.innerHTML = '<p class="text-center text-[var(--hint-color)] py-8">Загрузка...</p>';

      try {
        const [eventsResponse, adsResponse, votingsResponse] = await Promise.all([
          fetch(`${BACKEND_URL}/api/events`, { mode: 'cors' }),
          fetch(`${BACKEND_URL}/api/ads`, { mode: 'cors' }),
          fetch(`${BACKEND_URL}/api/votings`, { mode: 'cors' })
        ]);

        if (!eventsResponse.ok) throw new Error('Ошибка загрузки событий');

        const eventsData = await eventsResponse.json();
        const adsData = await adsResponse.json();
        const votingsData = await votingsResponse.json();

        eventsContainer.innerHTML = '';

        // Сначала голосования
        if (votingsData.records) {
          votingsData.records.forEach(record => {
            renderVotingItem(record);
          });
        }

        // Затем события и реклама
        let eventIndex = 0;
        if (eventsData.records) {
          eventsData.records.forEach((record, index) => {
            renderEventItem(record);
            eventIndex++;
            
            // Вставляем рекламу каждые 2 события
            if (eventIndex % 2 === 0 && adsData.records && adsData.records[eventIndex/2 - 1]) {
              renderAdItem(adsData.records[eventIndex/2 - 1]);
            }
          });
        }

        // Добавляем оставшуюся рекламу
        if (adsData.records) {
          const remainingAds = Math.max(0, adsData.records.length - Math.floor(eventIndex/2));
          for (let i = 0; i < remainingAds; i++) {
            renderAdItem(adsData.records[Math.floor(eventIndex/2) + i]);
          }
        }

      } catch (err) {
        eventsContainer.innerHTML = `<p class="text-center text-[var(--hint-color)] py-8">Ошибка: ${err.message}</p>`;
      }
    }

    // Исправленная функция голосования
    async function castVote(optionIndex) {
      if (!currentVotingRecord || !userLocation) return;

      try {
        const response = await fetch(`${BACKEND_URL}/api/votings/${currentVotingRecord.id}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: user.id,
            optionIndex: optionIndex,
            userLat: userLocation.latitude,
            userLon: userLocation.longitude
          })
        });

        if (response.ok) {
          const result = await response.json();
          alert('Ваш голос учтен!');
          showVotingModal(currentVotingRecord);
        } else {
          const error = await response.json();
          alert(error.error || 'Ошибка при голосовании');
        }
      } catch (err) {
        alert('Ошибка при голосовании');
      }
    }

    // Исправленная функция отображения результатов голосования
    function showVotingResults(voting, userVote) {
      const optionsContainer = document.getElementById('votingOptions');
      optionsContainer.innerHTML = '';

      if (voting.Options) {
        const options = voting.Options.split(',');
        const votes = typeof voting.Votes === 'string' ? JSON.parse(voting.Votes) : (voting.Votes || {});
        
        // Подсчет голосов
        const voteCounts = {};
        options.forEach((_, index) => {
          voteCounts[index] = 0;
        });

        Object.values(votes).forEach(voteIndex => {
          if (voteCounts[voteIndex] !== undefined) {
            voteCounts[voteIndex]++;
          }
        });

        const totalVotes = Object.values(voteCounts).reduce((sum, count) => sum + count, 0);

        options.forEach((option, index) => {
          const voteCount = voteCounts[index] || 0;
          const percentage = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
          const isUserChoice = userVote === index;

          const resultDiv = document.createElement('div');
          resultDiv.className = 'mb-4 p-4 bg-white rounded-lg border';
          resultDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium ${isUserChoice ? 'text-blue-600' : ''}">${option}</span>
              <span class="text-sm text-gray-500">${voteCount} голосов (${percentage}%)</span>
            </div>
            <div class="results-bar">
              <div class="results-fill" style="width: ${percentage}%"></div>
            </div>
            ${isUserChoice ? '<div class="text-xs text-blue-600 mt-1">✓ Ваш выбор</div>' : ''}
          `;
          optionsContainer.appendChild(resultDiv);
        });
      }
    }

    // Улучшенная функция редактирования голосований
    async function editVoting(recordId, title, description, lat, lon, options, eventId, status) {
      // Заполняем форму редактирования
      document.getElementById('votingRecordId').value = recordId;
      document.getElementById('votingTitle').value = title || '';
      document.getElementById('votingDescription').value = description || '';
      document.getElementById('votingLatitude').value = lat || '';
      document.getElementById('votingLongitude').value = lon || '';
      document.getElementById('votingEventId').value = eventId || '';

      // Загружаем варианты ответов
      const optionsContainer = document.getElementById('votingOptionsContainer');
      optionsContainer.innerHTML = '';

      if (options && options.length > 0) {
        options.forEach((option, index) => {
          addOption();
          const optionItems = optionsContainer.querySelectorAll('.option-item');
          const lastItem = optionItems[optionItems.length - 1];
          lastItem.querySelector('.option-name').value = option;
        });
      } else {
        addOption();
      }

      showTab('create-voting');
    }

    // Улучшенная функция сохранения голосования
    document.getElementById('votingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const recordId = document.getElementById('votingRecordId').value;
      const title = document.getElementById('votingTitle').value;
      const description = document.getElementById('votingDescription').value;
      
      // Собираем варианты ответов
      const options = [];
      document.querySelectorAll('.option-name').forEach(input => {
        if (input.value.trim()) {
          options.push(input.value.trim());
        }
      });

      if (options.length < 2) {
        alert('Добавьте хотя бы два варианта ответа');
        return;
      }

      const votingData = {
        fields: {
          Title: title,
          Description: description,
          Options: options.join(','),
          Votes: "{}", // Всегда инициализируем как пустой объект в формате строки
          VotedUserIDs: "",
          Status: "Active"
        }
      };

      try {
        const method = recordId ? 'PATCH' : 'POST';
        const url = recordId ? `${BACKEND_URL}/api/votings/${recordId}` : `${BACKEND_URL}/api/votings`;
        
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(votingData)
        });

        if (response.ok) {
          alert('Голосование сохранено');
          loadVotings();
          renderEvents();
          showTab('votings');
        } else {
          throw new Error('Ошибка сохранения');
        }
      } catch (err) {
        alert('Ошибка сохранения голосования');
      }
    });

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      applyTheme();
      initAdmin();
      renderEvents();
      loadEventsForVoting();
    });

    // Применение темы устройства
    function applyTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) {
        document.documentElement.style.setProperty('--bg-color', '#1a1a1a');
        document.documentElement.style.setProperty('--text-color', '#ffffff');
        document.documentElement.style.setProperty('--hint-color', '#8e8e93');
        document.documentElement.style.setProperty('--secondary-bg-color', '#2c2c2e');
      }
    }
  </script>
</body>
</html>