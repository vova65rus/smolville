<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Smolville Drift</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body {
      background-color: #1c1c1e;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      touch-action: pan-y;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      background: linear-gradient(to bottom, #1a1a1c, #1c1c1e);
      padding: 8px 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .ad-placeholder {
      font-size: 16px;
      color: #888;
    }

    header img {
      height: 24px;
      width: auto;
    }

    nav {
      position: fixed;
      top: 56px;
      width: 100%;
      z-index: 900;
      background: #1a1a1c;
      padding: 8px 0;
      border-bottom: 1px solid #2c2c2e;
      display: flex;
      justify-content: space-around;
    }

    nav button {
      flex: 1;
      padding: 4px;
      border: none;
      background: none;
      cursor: pointer;
      transition: color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    nav button i {
      font-size: 24px;
    }

    nav button span {
      font-size: 12px;
      margin-top: 4px;
    }

    .content {
      margin-top: 120px;
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .event-card {
      background: #2c2c2e;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .event-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .event-card h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .event-card p {
      font-size: 14px;
      color: #a0a0a0;
      margin-bottom: 12px;
    }

    .event-card .buttons {
      display: flex;
      justify-content: space-between;
    }

    .event-card button {
      flex: 1;
      padding: 8px;
      background: #3a3a3c;
      border: none;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .event-card button:hover {
      background-color: #4a4a4c;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2c2c2e;
      border-radius: 12px;
      padding: 16px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .modal-content img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .modal-content p {
      font-size: 14px;
      color: #a0a0a0;
      margin-bottom: 12px;
    }

    .modal-content .buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-content button {
      padding: 10px;
      background: #3a3a3c;
      border: none;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .modal-content button:hover {
      background-color: #4a4a4c;
    }

    .hidden {
      display: none;
    }

    ::-webkit-scrollbar {
      display: none;
    }
    html {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="flex items-center space-x-2">
      <div class="ad-placeholder">AD</div>
      <div class="text-sm">Telegram Mini App</div>
    </div>
    <img src="https://raw.githubusercontent.com/vova65rus/smolville/main/logo.PNG" alt="Smolville Drift Logo" class="h-6 w-auto">
  </header>

  <nav>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="profile">
      <i class="fas fa-user fa-lg"></i>
      <span class="text-xs mt-1">Профиль</span>
    </button>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="events">
      <i class="fas fa-calendar-alt fa-lg"></i>
      <span class="text-xs mt-1">Афиша</span>
    </button>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="voting">
      <i class="fas fa-poll fa-lg"></i>
      <span class="text-xs mt-1">Голосование</span>
    </button>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="marketplace">
      <i class="fas fa-shopping-cart fa-lg"></i>
      <span class="text-xs mt-1">Барахолка</span>
    </button>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="favorites">
      <i class="fas fa-heart fa-lg"></i>
      <span class="text-xs mt-1">Избранное</span>
    </button>
    <button class="flex flex-col items-center text-gray-400 hover:text-white" data-action="map">
      <i class="fas fa-map-marker-alt fa-lg"></i>
      <span class="text-xs mt-1">Карта</span>
    </button>
    <button id="adminBtn" class="flex flex-col items-center text-gray-400 hover:text-white hidden" data-action="admin">
      <i class="fas fa-cog fa-lg"></i>
      <span class="text-xs mt-1">Админ</span>
    </button>
  </nav>

  <div id="content" class="content hidden">
    <div id="events" class="events">
      <h1 class="text-2xl font-bold mb-4">Афиша</h1>
      <div id="eventsList"></div>
    </div>
    <div id="profile" class="profile hidden">
      <h1 class="text-2xl font-bold mb-4">Профиль</h1>
      <div id="profileContent"></div>
    </div>
    <div id="voting" class="voting hidden">
      <h1 class="text-2xl font-bold mb-4">Голосование</h1>
      <div id="votingContent"></div>
    </div>
    <div id="marketplace" class="marketplace hidden">
      <h1 class="text-2xl font-bold mb-4">Барахолка</h1>
      <p class="text-gray-400">В разработке</p>
    </div>
    <div id="favorites" class="favorites hidden">
      <h1 class="text-2xl font-bold mb-4">Избранное</h1>
      <p class="text-gray-400">В разработке</p>
    </div>
    <div id="map" class="map hidden">
      <h1 class="text-2xl font-bold mb-4">Карта</h1>
      <p class="text-gray-400">В разработке</p>
    </div>
    <div id="admin" class="admin hidden">
      <h1 class="text-2xl font-bold mb-4">Админ-панель</h1>
      <p class="text-gray-400">В разработке</p>
    </div>
  </div>

  <div id="eventModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <img id="modalImage" alt="Event Image">
      <p id="modalDate"></p>
      <p id="modalLocation"></p>
      <p id="modalDescription"></p>
      <div class="buttons">
        <button id="joinBtn">Я пойду</button>
        <button id="mapBtn">На карте</button>
        <button id="closeModal">Закрыть</button>
      </div>
    </div>
  </div>

  <div id="votingModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="votingModalTitle"></h2>
      <p id="votingModalDate"></p>
      <p id="votingModalLocation"></p>
      <div id="votingCategories"></div>
      <button id="submitVoteBtn">Проголосовать</button>
      <button id="closeVotingModal">Закрыть</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    const user = tg.initDataUnsafe?.user || { id: 0, first_name: 'Гость', photo_url: '' };
    const adminId = 366825437; // Замените на реальный ID админа
    const isAdmin = user.id === adminId;
    if (isAdmin) document.getElementById('adminBtn').classList.remove('hidden');

    const AIRTABLE_API_KEY = 'your_airtable_api_key'; // Замените на реальный ключ
    const AIRTABLE_BASE_ID = 'your_airtable_base_id';
    const AIRTABLE_EVENTS_TABLE = 'tblEvents';
    const AIRTABLE_VOTING_TABLE = 'tblVoting';
    const AIRTABLE_USERS_TABLE = 'tblUsers';
    const AIRTABLE_API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}`;
    const EVENTS_API_URL = `${AIRTABLE_API_URL}/${encodeURIComponent(AIRTABLE_EVENTS_TABLE)}`;
    const VOTING_API_URL = `${AIRTABLE_API_URL}/${encodeURIComponent(AIRTABLE_VOTING_TABLE)}`;
    const USERS_API_URL = `${AIRTABLE_API_URL}/${encodeURIComponent(AIRTABLE_USERS_TABLE)}`;
    const APP_URL = 'https://your-miniapp-url'; // Замените на URL вашего приложения

    let userEvents = [];
    let userVotes = {};

    const content = document.getElementById('content');
    const eventsList = document.getElementById('eventsList');
    const profileContent = document.getElementById('profileContent');
    const votingContent = document.getElementById('votingContent');
    const eventModal = document.getElementById('eventModal');
    const votingModal = document.getElementById('votingModal');
    const navButtons = document.querySelectorAll('nav button');

    function showSection(sectionId) {
      content.querySelectorAll('div').forEach(div => div.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    navButtons.forEach(button => {
      button.addEventListener('click', () => {
        navButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const action = button.dataset.action;
        showSection(action);
        if (action === 'events') renderEvents();
        else if (action === 'profile') renderProfile();
        else if (action === 'voting') renderVoting();
        else if (action === 'marketplace' || action === 'favorites' || action === 'map') tg.showAlert(`${button.querySelector('span').textContent} в разработке`);
        else if (action === 'admin' && isAdmin) tg.showAlert('Админ-панель в разработке');
      });
    });

    async function renderEvents() {
      eventsList.innerHTML = '<p class="text-gray-400 text-center">Загрузка...</p>';
      try {
        const response = await fetch(EVENTS_API_URL, {
          headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
        });
        const data = await response.json();
        eventsList.innerHTML = '';
        if (!data.records || data.records.length === 0) {
          eventsList.innerHTML = '<p class="text-gray-400 text-center">Нет мероприятий</p>';
          return;
        }
        data.records.forEach(event => {
          const card = document.createElement('div');
          card.className = 'event-card';
          card.innerHTML = `
            <img src="${event.fields.Image?.[0]?.url || 'https://via.placeholder.com/300x180'}" alt="${event.fields.Title}">
            <h2>${event.fields.Title}</h2>
            <p>${event.fields.Date || 'Дата не указана'}</p>
            <div class="buttons">
              <button class="join-btn" data-id="${event.id}">Я пойду</button>
              <button class="map-btn" data-id="${event.id}">На карте</button>
            </div>
          `;
          card.querySelector('.join-btn').addEventListener('click', () => joinEvent(event.id));
          card.querySelector('.map-btn').addEventListener('click', () => showEventDetails(event));
          eventsList.appendChild(card);
        });
      } catch (err) {
        eventsList.innerHTML = '<p class="text-gray-400 text-center">Ошибка загрузки</p>';
        console.error(err);
      }
    }

    async function renderProfile() {
      profileContent.innerHTML = '<p class="text-gray-400 text-center">Загрузка...</p>';
      try {
        const response = await fetch(`${USERS_API_URL}?filterByFormula={TgId}="${user.id}"`, {
          headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
        });
        const data = await response.json();
        const userData = data.records[0]?.fields || {};
        profileContent.innerHTML = `
          <h2 class="text-xl font-semibold">${userData.Name || user.first_name || 'Гость'}</h2>
          <img src="${userData.Avatar || user.photo_url || 'https://via.placeholder.com/100'}" alt="Avatar" class="w-24 h-24 rounded-full mt-2">
          <p class="mt-2">${userData.Contacts || 'Нет контактов'}</p>
          <h3 class="text-lg font-semibold mt-4">Участие в событиях</h3>
          <div id="profileEvents" class="mt-2">${userEvents.length ? userEvents.map(id => `<p>${id}</p>`).join('') : '<p>Нет событий</p>'}</div>
        `;
      } catch (err) {
        profileContent.innerHTML = '<p class="text-gray-400 text-center">Ошибка загрузки</p>';
        console.error(err);
      }
    }

    async function renderVoting() {
      votingContent.innerHTML = '<p class="text-gray-400 text-center">Загрузка...</p>';
      try {
        const response = await fetch(VOTING_API_URL, {
          headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
        });
        const data = await response.json();
        votingContent.innerHTML = '';
        if (!data.records || data.records.length === 0) {
          votingContent.innerHTML = '<p class="text-gray-400 text-center">Нет голосований</p>';
          return;
        }
        data.records.forEach(voting => {
          const card = document.createElement('div');
          card.className = 'event-card';
          card.innerHTML = `
            <h2>${voting.fields.Title}</h2>
            <p>${voting.fields.Date || 'Дата не указана'}</p>
            <button class="vote-btn" data-id="${voting.id}">Голосовать</button>
          `;
          card.querySelector('.vote-btn').addEventListener('click', () => showVotingDetails(voting));
          votingContent.appendChild(card);
        });
      } catch (err) {
        votingContent.innerHTML = '<p class="text-gray-400 text-center">Ошибка загрузки</p>';
        console.error(err);
      }
    }

    async function joinEvent(eventId) {
      try {
        userEvents.push(eventId);
        await saveUserData();
        tg.showAlert('Вы записаны на мероприятие!');
        renderProfile();
      } catch (err) {
        tg.showAlert('Ошибка записи');
        console.error(err);
      }
    }

    async function saveUserData() {
      const userData = {
        fields: {
          TgId: String(user.id),
          Name: user.first_name,
          Avatar: user.photo_url || '',
          Events: userEvents
        }
      };
      try {
        const response = await fetch(USERS_API_URL, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${AIRTABLE_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });
        if (!response.ok) throw new Error(await response.text());
      } catch (err) {
        console.error('Ошибка сохранения данных:', err);
      }
    }

    function showEventDetails(event) {
      document.getElementById('modalTitle').textContent = event.fields.Title;
      document.getElementById('modalDate').textContent = event.fields.Date || 'Дата не указана';
      document.getElementById('modalLocation').textContent = event.fields.Location || 'Место не указано';
      document.getElementById('modalDescription').textContent = event.fields.Description || 'Описание отсутствует';
      document.getElementById('modalImage').src = event.fields.Image?.[0]?.url || 'https://via.placeholder.com/300x200';
      document.getElementById('mapBtn').onclick = () => window.open(event.fields.MapLink || '#', '_blank');
      eventModal.classList.remove('hidden');
    }

    document.getElementById('joinBtn').addEventListener('click', () => {
      const eventId = eventModal.querySelector('.map-btn')?.dataset.id;
      if (eventId) joinEvent(eventId);
      eventModal.classList.add('hidden');
    });

    document.getElementById('closeModal').addEventListener('click', () => eventModal.classList.add('hidden'));

    async function showVotingDetails(voting) {
      const isWithinRange = await checkGeolocation(voting.fields.Latitude, voting.fields.Longitude);
      if (!isWithinRange) {
        tg.showAlert('Вы не находитесь в зоне голосования (1000 м)');
        return;
      }
      document.getElementById('votingModalTitle').textContent = voting.fields.Title;
      document.getElementById('votingModalDate').textContent = voting.fields.Date || 'Дата не указана';
      document.getElementById('votingModalLocation').textContent = voting.fields.Location || 'Место не указано';
      const categories = JSON.parse(voting.fields.Categories || '[]');
      const votingCategories = document.getElementById('votingCategories');
      votingCategories.innerHTML = categories.map(cat => `
        <div>
          <p class="font-semibold">${cat.name}</p>
          <select class="w-full p-2 bg-gray-700 rounded mt-1">
            ${cat.cars.map(car => `<option value="${car}">${car}</option>`).join('')}
          </select>
        </div>
      `).join('');
      votingModal.dataset.votingId = voting.id;
      votingModal.classList.remove('hidden');
    }

    document.getElementById('submitVoteBtn').addEventListener('click', () => {
      const votingId = votingModal.dataset.votingId;
      const votes = {};
      document.querySelectorAll('#votingCategories select').forEach(select => {
        votes[select.previousElementSibling.textContent] = select.value;
      });
      userVotes[votingId] = votes;
      saveUserData().then(() => {
        tg.showAlert('Ваш голос учтен!');
        votingModal.classList.add('hidden');
      });
    });

    document.getElementById('closeVotingModal').addEventListener('click', () => votingModal.classList.add('hidden'));

    function checkGeolocation(lat, lon) {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve(false);
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const distance = getDistance(lat, lon, position.coords.latitude, position.coords.longitude);
            resolve(distance <= 1000);
          },
          () => resolve(false),
          { enableHighAccuracy: true, timeout: 5000 }
        );
      });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Радиус Земли в метрах
      const φ1 = (lat1 * Math.PI) / 180;
      const φ2 = (lat2 * Math.PI) / 180;
      const Δφ = ((lat2 - lat1) * Math.PI) / 180;
      const Δλ = ((lon2 - lon1) * Math.PI) / 180;
      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Инициализация
    navButtons[0].click(); // Открыть профиль по умолчанию
  </script>
</body>
</html>
